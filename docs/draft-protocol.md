# Draft / Apply / Cancel — протокол

## 1. Цель

- Все изменения во внешних системах происходят только после кнопки **«Применить»**.
- **«Отмена»** гарантирует отсутствие изменений.
- Повторные нажатия не создают дублей.

## 2. Draft

Draft содержит:

- нормализованный вход (text/transcript/forward)
- actions
- предположения
- риски
- вопросы

## 3. Apply

1) Проверить Draft: существует, `status=DRAFT`, не истёк.
2) Записать попытку в `draft_apply_attempts`.
3) Выполнить actions.
4) Зафиксировать per-action outcome.
5) Draft → `APPLIED` (в т.ч. частично) + summary.

## 4. Cancel

Draft → `CANCELLED`.

## 5. TTL / Expire

Draft имеет `expires_at`.

## 6. Callback data

- `apply:<draft_id>`
- `cancel:<draft_id>`

## 7. Идемпотентность

- `(draft_id, callback_query_id)` уникально

## 8. Быстрые правки до Apply (финально)

Для сценария `/task`, если исполнитель не определён:

- Draft создаётся всегда
- в подтверждении доступна кнопка **«Назначить исполнителя»**
- после выбора исполнителя Draft обновляется, затем можно нажать Apply

Важно: бот **не угадывает** исполнителя при коллизии (несколько кандидатов) — только предлагает выбрать.
