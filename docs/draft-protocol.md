# Draft / Apply / Cancel — протокол

## 1. Цель

Сделать поведение бота безопасным и предсказуемым:

- Все изменения во внешних системах происходят только после кнопки **«Применить»**.
- **«Отмена»** гарантирует отсутствие изменений.
- Повторные нажатия не создают дублей.

## 2. Draft

Draft — единица работы, содержащая:

- нормализованный вход (text/transcript)
- список actions
- предположения
- риски
- вопросы (если критично)

## 3. Apply

При apply:

1. Проверить Draft: существует, `status=DRAFT`, не истёк.
2. Записать попытку применения в `draft_apply_attempts`.
3. Выполнить actions **последовательно** или батчами по платформам.
4. Зафиксировать результат каждого action:
   - success + внешние идентификаторы/urls
   - или error + причина
5. Итог:
   - Draft → `APPLIED` (даже если частично), но с `apply_summary`.

## 4. Cancel

1. Проверить Draft.
2. Draft → `CANCELLED`.
3. Обновить сообщение подтверждения (или отправить новое) с текстом «Отменено».

## 5. TTL / Expire

Draft имеет `expires_at`.

- Если просрочен: `EXPIRED`, apply/cancel не выполняются.

## 6. Callback data

- `apply:<draft_id>`
- `cancel:<draft_id>`

Draft_id должен быть коротким (например UUID v4 или ULID).

## 7. Идемпотентность

- (draft_id, callback_query_id) — уникальная пара для попытки применения.
- Повторный apply возвращает тот же результат.
