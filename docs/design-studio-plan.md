# План и архитектура Telegram-бота для управления дизайн-студией (Attio + Linear + Supabase)

## Статус
- Этот документ — **финальная спецификация на согласование**.
- Основа: паттерн **Draft → Confirm (Apply/Cancel) → Execute** из репозитория.

## Вводные (зафиксировано)
- **Attio**: `deals` = все пресейл-сделки.
- Воронка (stages):
  1) Новый лид
  2) Квалификация
  3) Брифинг
  4) КП отправлено
  5) Переговоры
  6) Согласование договора
  7) На паузе
  8) Выиграно
  9) Проиграно
- **Linear**: 1 команда, много проектов, много задач внутри проектов.
- Пользователи бота: **CEO и COO**.
- Клиентских Telegram-чатов пока нет (бот внутренний).
- **Принято**: Linear Project **создаётся автоматически** при переводе сделки в **«Выиграно»**.

## Ключевые продуктовые принципы
1. **Безопасность**: любое изменение в Attio/Linear только через Draft → Apply.
2. **Идемпотентность**: повторный Apply не создаёт дубли (проектов/задач/апдейтов).
3. **Разделение источников истины**:
   - Attio = пресейл и коммерция
   - Linear = производство
   - Supabase = связи, контексты, идемпотентность, кеши, аудит
4. **Минимальный friction**: CEO/COO могут управлять всем из Telegram, не заходя в CRM/PM.

## Ответы на “контрольные вопросы” (я отвечаю сам и фиксирую решения)
### 1) Нейминг Linear Project
**Решение:** `Company — Deal name`.
- Если company не определена: `Deal — <deal name>`.

### 2) Шаблон задач при kickoff
**Решение:** стартуем с дефолтного шаблона из 12 задач (ниже), далее заменяем на ваш студийный шаблон без изменения архитектуры.

### 3) Напоминания по стадии «На паузе»
**Решение:** да, включаем напоминания.
- Правило: если сделка в стадии **«На паузе»** и не было активности/обновлений **7 дней**, бот шлёт CEO/COO напоминание.
- Настройка `N=7` хранится в Supabase и может быть изменена командой админа.

## Функционал (MVP → расширение)

### MVP (1–2 недели): Presale control + Auto-kickoff
#### Команды
| Команда | Назначение | Мутации | Draft/Apply |
|---|---|---|---|
| `/deal find <text>` | Найти сделку | нет | нет |
| `/deal view <deal>` | Карточка сделки | нет | нет |
| `/deal stage <deal> <stage>` | Перевод по воронке | Attio update deal | да |
| `/deal won <deal>` | Перевести в «Выиграно» и запустить kickoff | Attio + Linear + Supabase | да |
| `/pipeline` | Сводка по стадиям | нет | нет |
| `/audit last` | Последние Apply | нет | нет |
| `/sync` | Обновить кеши (Linear справочники) | Supabase upsert | нет |

#### Auto-kickoff (что делает `/deal won`)
Draft preview должен явно перечислять:
1. Перевод сделки в стадию **Выиграно**.
2. Создание **Linear Project** (имя по правилу выше) в единственной команде.
3. Создание стартовых задач по шаблону.
4. Запись связи `attio_deal_id ↔ linear_project_id`.

### Phase 2 (2–3 недели): Production visibility
- `/project status <deal|project>`: сводка задач по статусам.
- `/task <text>`: быстро создать issue в “контекстном” проекте.
- Дайджесты: просрочки, проекты без активности, задачи на ревью.

### Phase 3 (3–5 недель): Системность
- Шаблоны kickoff по `Направление` (attio `napravlenie` multi-select).
- Автоматические follow-ups по стадиям.
- Метрики: время в стадиях, конверсия, активность.

## Шаблон задач kickoff (дефолт 12)
Каждая задача создаётся в Linear с:
- ссылкой на Attio deal (в описании)
- `template_task_key` (для идемпотентности)

| key | Title |
|---|---|
| kickoff_access | Kickoff: собрать материалы и доступы |
| brief_confirm | Бриф: собрать ответы / утвердить требования |
| research_refs | Исследование: референсы + конкурентный обзор |
| moodboard | Мудборд / визуальное направление |
| ia_structure | Инфоархитектура / структура |
| wireframes | Wireframes основных экранов |
| concept | Визуальная концепция (1–2 варианта) |
| ui_kit | UI kit / компоненты (база) |
| designs_key | Макеты: ключевые экраны (MVP) |
| responsive | Адаптивы (если нужны) |
| handoff | Handoff: экспорт ассетов + спецификация |
| final_qc | Финальная проверка и передача |

## Архитектура

### Компоненты
- Telegram webhook handler (Cloudflare Worker)
- Draft Engine (строит actions + вопросы)
- Executor (применяет actions)
- Supabase Postgres (state-store)
- Jobs (sync + reminders)

### Draft → Apply протокол (обязательно для мутаций)
- Draft хранит: вход, список actions, human-readable preview, вопросы/risks.
- Apply:
  - блокировка draft (одновременные Apply исключены)
  - выполнение actions по очереди
  - запись результата per action
  - финальный отчёт

### Идемпотентность (критично)
- Apply всегда пишет `idempotency_key`.
- Для kickoff:
  - `deal_linear_links.attio_deal_id` уникален → 1 проект на 1 сделку.
  - `project_template_tasks (linear_project_id, template_task_key)` уникален → 1 задача на 1 key.

## Модель данных Supabase (минимум)
| Таблица | Назначение |
|---|---|
| `users` | whitelist CEO/COO, роли |
| `drafts` | Draft state + TTL |
| `draft_actions` | actions и результаты |
| `idempotency_keys` | защита от дублей |
| `deal_stages` | справочник стадий |
| `deal_stage_aliases` | алиасы стадий |
| `deal_linear_links` | mapping deal→project |
| `project_template_tasks` | идемпотентность задач шаблона |
| `audit_log` | кто что применил |
| `reminders` | расписание/история напоминаний |

## Напоминания (MVP+)
- Rule: Stage=«На паузе» + нет активности 7 дней → ping CEO/COO.
- Активность: change stage/value/owner или добавленная note (через бота), либо ручной sync.

## Согласование
Пожалуйста, подтвердите 3 пункта (ожидаю ответ «Ок»):
1. Нейминг Linear Project: `Company — Deal name`.
2. Шаблон kickoff: 12 задач по умолчанию.
3. Reminder: «На паузе» → 7 дней → напоминание CEO/COO.
