# Полная функциональная спецификация (финальная)

## 1. Назначение

Telegram-бот ассистент принимает **текст**, **голос** и **пересланные сообщения** и преобразует их в **черновик действий (Draft)** для:

- **Attio (CRM)** — People + Companies (в т.ч. массово), заметки.  
- **Linear (PM)** — задачи (issues) и материалы по ТЗ.

Далее бот отправляет пользователю подтверждение с двумя кнопками:

- **«Применить»** — выполнить действия.  
- **«Отмена»** — отменить и ничего не менять.

Изменения в Attio/Linear не выполняются без подтверждения.

## 2. Режимы управления: кнопки + свободный ввод

### 2.1 Кнопочный UI

Бот предоставляет меню/кнопки:

- **Задача** (`/task`)  
- **Клиенты (массово)** (`/client-mass`)  
- **ТЗ** (`/tz`)  
- **Черновики** (последние Draft)  
- **Настройки** (дефолты: Linear team, due time, язык)

### 2.2 Свободный ввод (текст/голос)

Пользователь может просто написать/наговорить просьбу; бот:

1. распознаёт сценарий;  
2. строит Draft;  
3. предлагает выполнить через **Применить/Отмена** (и быстрые правки).

## 3. Draft (единый протокол)

Требования к Draft и Apply описаны в [docs/draft-protocol.md](draft-protocol.md).

### 3.1 Состояния

- `DRAFT`  
- `APPLIED`  
- `CANCELLED`  
- `EXPIRED`

### 3.2 Идемпотентность

- `(draft_id, callback_query_id)` уникально;  
- повторный Apply не создаёт дубль.

### 3.3 Частичное применение

Разрешено (особенно для bulk): валидные элементы применяются, невалидные — пропускаются с отчётом.

## 4. Сценарий `/task`: задача из пересланного сообщения → Linear

### 4.1 Флоу

1. `/task`  
2. бот: «пришли/перешли сообщение… потом допиши контекст (исполнитель, дедлайн, приоритет)…»  
3. пользователь пересылает сообщение + добавляет контекст/медиа  
4. бот формирует Draft (title/description/assignee/due/priority)  
5. подтверждение: **Применить/Отмена**

### 4.2 Важное решение: assignee

Если сотрудник не найден в Linear:

- Draft создаётся **всегда** (чтобы не потерять задачу)  
- в карточке показывается warning: «Исполнитель не определён»  
- появляется кнопка **«Назначить исполнителя»**:  
  - быстрый список (Я + последние/частые)  
  - ввод имени/ника  
  - при коллизии (несколько кандидатов) — выбор, без угадываний

## 5. Сценарий `/client-mass`: массовые People+Companies → Attio

### 5.1 Вход

Текст блоками `Клиенты:` и `Команда:`.

### 5.2 Обязательные поля

- Клиент (Person): имя, телефон/telegram, должность, компания/проект  
- Команда (Person): имя, телефон/telegram, комментарий  
- Company: name или domain (domain приоритетнее)

### 5.3 Важное решение: комментарии

- Всегда создаём **Note** на Person с полным комментарием (история + timestamp)  
- В `description` — только **короткий summary**, и только если это безопасно:  
  - если description пустой → записать summary  
  - если заполнен → не перетирать; оставить только Note

## 6. Сценарий `/tz`: интерактивное ТЗ (pro-качество)

- бот задаёт уточняющие вопросы  
- затем генерирует финальное ТЗ  
- Draft предлагает создать Linear issue/document

## 7. Design Studio: `/deal won` — Выигрыш сделки и автозапуск production

Этот сценарий фиксируется также в [docs/design-studio-plan.md](design-studio-plan.md).

### 7.1 UX и пример диалога

Команда:
- `/deal won <deal>`

Цель:
- перевести сделку в **«Выиграно»** в Attio
- создать **Linear Project**
- создать **12 стартовых задач** по шаблону
- сохранить mapping `attio_deal_id ↔ linear_project_id`

Пример диалога (в сообщениях):

- Бот: «Сделка будет переведена в “Выиграно”. Я создам проект в Linear и 12 задач по шаблону. Применить/Отмена?»
- Пользователь: «Применить»
- Бот: «Готово: стадия обновлена, проект создан, задачи созданы. Ссылки: …»

### 7.2 Draft payload (что храним)

Draft должен содержать минимум:

- `attio_deal_id`
- `attio_deal_name`
- `attio_company_id` (если есть)
- `attio_company_name` (если есть)
- `target_stage_key = won`
- `linear_team_id` (фиксированная команда)
- `linear_project_name` (правило: `Company — Deal name`, иначе `Deal — Deal name`)
- `template_tasks[]` (12 элементов с `template_task_key`, `title`, `description`)

### 7.3 Actions (что выполняем на Apply)

Порядок действий (важен):

1. **Attio: update deal stage → “Выиграно”**
2. **Supabase: ensure link**
   - если `bot.deal_linear_links` для `attio_deal_id` уже существует → перейти к шагу 4
3. **Linear: create project**
   - создать проект с `linear_project_name`
   - записать в `bot.deal_linear_links` (deal→project)
4. **Linear: create issues (template)**
   - для каждой задачи из шаблона создать issue в созданном/существующем проекте
   - после успешного создания — записать строку в `bot.project_template_tasks`

### 7.4 Идемпотентность (как предотвращаем дубли)

Идемпотентность уровня Draft:
- уникальная пара `(draft_id, callback_query_id)`

Идемпотентность доменная:
- **1 проект на 1 сделку**: `bot.deal_linear_links.attio_deal_id` — PRIMARY KEY
- **1 шаблонная задача на 1 проект**: `bot.project_template_tasks (linear_project_id, template_task_key)` — PRIMARY KEY

Алгоритм повторного Apply:
- если линк уже существует — проект не создаём
- если часть задач уже создана — создаём только недостающие keys

### 7.5 Ошибки и recovery

#### Ошибка: Attio stage обновили, Linear project не создался
- Draft остаётся в статусе `DRAFT` (или `APPLIED_PARTIAL`, если заведёте)
- повторный Apply:
  - увидит, что stage уже “Выиграно” (это ок)
  - попробует снова создать проект

#### Ошибка: проект создан, часть задач не создалась
- повторный Apply создаёт только те задачи, по которым нет строки в `bot.project_template_tasks`

#### Линк уже существует
- бот отвечает: «Проект уже привязан к сделке. Создам недостающие задачи (если есть).»

#### Не удалось определить компанию
- `linear_project_name = Deal — <deal name>`
- в audit фиксируем `company_missing=true`

### 7.6 Минимальные требования к данным

- Attio: `attio_deal_id`, `attio_deal_name` обязательны
- Linear: `linear_team_id` обязателен

### 7.7 Логирование (audit)

На Apply бот создаёт записи аудита:
- `deal.stage.update` (success/fail)
- `linear.project.create` (success/fail + project_id)
- `linear.issue.create` (per task key)
- итоговый `draft.apply.summary`

## 8. Design Studio: `/deal stage` — смена стадии сделки

### 8.1 UX

Команда:
- `/deal stage <deal> <stage>`

Пример:
- `/deal stage 06694a86 КП отправлено`

Бот:
- разрешает ввод `stage` по имени или алиасу (`кп`, `договор`, `пауза`)
- делает Draft с явным preview

### 8.2 Draft payload

- `attio_deal_id`
- `target_stage_key`
- `target_stage_name`

### 8.3 Actions

- Attio: update deal stage

### 8.4 Идемпотентность

- Если текущая стадия уже целевая — действие считается выполненным без мутации.

### 8.5 Ошибки

- Сетевая/валидационная ошибка → Draft остаётся `DRAFT`, можно повторить Apply.

## 9. Хранилище (Supabase)

Схема и reset описаны в `docs/supabase/*`, а миграции — в `supabase/migrations/*`.

## 10. Настройки

- default Linear team  
- default due time  
- язык  
- политики дедупликации (bulk)
