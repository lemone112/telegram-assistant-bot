# Полная функциональная спецификация

## 1. Назначение

Telegram-бот ассистент принимает **текст** и **голос** (voice) и преобразует их в **черновик действий (Draft)** для:

- **Attio (CRM)** — отношения/контакты/компании/сделки/заметки/вебхуки/атрибуты.
- **Linear (PM)** — задачи (issues), поиск/обновление/связи и расширенные операции через GraphQL.

Далее бот отправляет пользователю подтверждение с двумя кнопками:

- **«Применить»** — выполнить действия.
- **«Отмена»** — отменить и ничего не менять.

Изменения в Attio/Linear не выполняются без подтверждения.

## 2. Неформальный ввод → структура (Draft)

### 2.1 Источники ввода

- `text` — обычное сообщение.
- `voice` — голосовое сообщение Telegram (с транскрипцией).

### 2.2 Транскрипция голоса

- Используем OpenAI Transcription (рекомендуемая модель: `gpt-4o-mini-transcribe`).
- Результат транскрипции сохраняем в Draft как `transcript`.

### 2.3 Извлечение намерения и роутинг

MCP Composio должен:

- определить целевые платформы: `attio`, `linear` или обе.
- построить список действий (actions) для каждой платформы.
- выделить **предположения** (assumptions) и **риски** (risk).
- при необходимости сформировать **уточняющие вопросы**.

## 3. Черновик (Draft)

### 3.1 Состояния

- `DRAFT` — создан, ждёт подтверждения.
- `APPLIED` — успешно применён (полностью или частично).
- `CANCELLED` — отменён пользователем.
- `EXPIRED` — просрочен (TTL), кнопки больше не действуют.

### 3.2 Идемпотентность

- Повторное нажатие «Применить» не должно создавать дубликаты.
- Для каждого Draft фиксируем `idempotency_key` и журнал попыток применения.

### 3.3 Частичное применение

Разрешено частичное применение:

- если часть действий (например, Attio) не может выполниться из-за нехватки данных или ошибки API,
  другая часть (например, Linear) может выполниться.
- итоговое сообщение пользователю обязано отражать **что получилось**, а **что нет** и почему.

## 4. Telegram UX

### 4.1 Карточка подтверждения

Карточка должна содержать:

- краткое резюме намерения
- список действий в Attio
- список действий в Linear
- предупреждения/риски (если есть)
- кнопки: **«Применить»** и **«Отмена»**

### 4.2 Callback-обработчики

- `apply:<draft_id>` — применить.
- `cancel:<draft_id>` — отменить.

Worker обязан проверять:

- что `draft_id` существует
- что Draft в состоянии `DRAFT`
- что Draft не истёк

## 5. Встроенные действия (каталог)

Подробные каталоги см.:

- [Attio actions](attio/actions.md)
- [Linear actions](linear/actions.md)

## 6. Хранилище (Supabase)

- Supabase используется как единое хранилище Draft/пользователей/логов.
- Лимит: **500MB** — поэтому:
  - не храним большие вложения
  - транскрипты и исходные тексты ограничиваем по длине
  - логи делаем компактными (с агрегацией)

Подробная схема: [Supabase schema](supabase/schema.md)

## 7. Набор переменных окружения (концептуально)

- `TELEGRAM_BOT_TOKEN`
- `TELEGRAM_WEBHOOK_SECRET` (если используем секрет/проверку)
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `COMPOSIO_API_KEY / MCP endpoint` (как будет принято в реализации)
- `OPENAI_API_KEY` (если STT напрямую)
- `DEFAULT_LINEAR_TEAM_ID` (и опционально project/state defaults)
- `DEFAULT_TIMEZONE=Europe/London`

## 8. Политики очистки и TTL

- Draft TTL (например 24 часа).
- Авто-очистка старых логов (например 30–90 дней).
- Ограничение объёма таблиц.

## 9. Нефункциональные требования

- Безопасность: никаких write-операций без подтверждения.
- Наблюдаемость: audit trail на каждый Draft и каждый apply/cancel.
- Повторяемость: документация должна позволять вернуться в проект и продолжить.
