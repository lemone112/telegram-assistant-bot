# Полная функциональная спецификация (финальная)

## 1. Назначение

Telegram-бот ассистент принимает **текст**, **голос** и **пересланные сообщения** и преобразует их в **черновик действий (Draft)** для:

- **Attio (CRM)** — People + Companies (в т.ч. массово), заметки.
- **Linear (PM)** — задачи (issues) и материалы по ТЗ.

Далее бот отправляет пользователю подтверждение с двумя кнопками:

- **«Применить»** — выполнить действия.
- **«Отмена»** — отменить и ничего не менять.

Изменения в Attio/Linear не выполняются без подтверждения.

## 2. Режимы управления: кнопки + свободный ввод

### 2.1 Кнопочный UI
Бот предоставляет меню/кнопки:

- **Задача** (`/task`)
- **Клиенты (массово)** (`/client-mass`)
- **ТЗ** (`/tz`)
- **Черновики** (последние Draft)
- **Настройки** (дефолты: Linear team, due time, язык)

### 2.2 Свободный ввод (текст/голос)
Пользователь может просто написать/наговорить просьбу; бот:

1) распознаёт сценарий
2) строит Draft
3) предлагает выполнить через **Применить/Отмена** (и быстрые правки)

## 3. Draft (единый протокол)

### 3.1 Состояния
- `DRAFT`
- `APPLIED`
- `CANCELLED`
- `EXPIRED`

### 3.2 Идемпотентность
- `(draft_id, callback_query_id)` уникально
- повторный Apply не создаёт дубль

### 3.3 Частичное применение
Разрешено (особенно для bulk): валидные элементы применяются, невалидные — пропускаются с отчётом.

## 4. Сценарий `/task`: задача из пересланного сообщения → Linear

### 4.1 Флоу
1) `/task`
2) бот: «пришли/перешли сообщение… потом допиши контекст (исполнитель, дедлайн, приоритет)…»
3) пользователь пересылает сообщение + добавляет контекст/медиа
4) бот формирует Draft (title/description/assignee/due/priority)
5) подтверждение: **Применить/Отмена**

### 4.2 Важное решение: assignee
Если сотрудник не найден в Linear:

- Draft создаётся **всегда** (чтобы не потерять задачу)
- в карточке показывается warning: «Исполнитель не определён»
- появляется кнопка **«Назначить исполнителя»**:
  - быстрый список (Я + последние/частые)
  - ввод имени/ника
  - при коллизии (несколько кандидатов) — выбор, без угадываний

## 5. Сценарий `/client-mass`: массовые People+Companies → Attio

### 5.1 Вход
Текст блоками `Клиенты:` и `Команда:`.

### 5.2 Обязательные поля
- Клиент (Person): имя, телефон/telegram, должность, компания/проект
- Команда (Person): имя, телефон/telegram, комментарий
- Company: name или domain (domain приоритетнее)

### 5.3 Важное решение: комментарии
- Всегда создаём **Note** на Person с полным комментарием (история + timestamp)
- В `description` — только **короткий summary**, и только если это безопасно:
  - если description пустой → записать summary
  - если заполнен → не перетирать; оставить только Note

## 6. Сценарий `/tz`: интерактивное ТЗ (pro-качество)

- бот задаёт уточняющие вопросы
- затем генерирует финальное ТЗ
- Draft предлагает создать Linear issue/document

## 7. Хранилище (Supabase)

Схема и reset описаны в `docs/supabase/*`.

## 8. Настройки

- default Linear team
- default due time
- язык
- политики дедупликации (bulk)
